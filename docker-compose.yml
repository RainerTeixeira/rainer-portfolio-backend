name: blog-api

services:
  # MongoDB para desenvolvimento local
  mongodb:
    image: mongo:7.0
    container_name: blog-api-mongodb
    ports:
      - "27017:27017"
    command: mongod --replSet rs0 --bind_ip_all
    environment:
      MONGO_INITDB_DATABASE: rainer-portfolio
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      - ./scripts/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    restart: unless-stopped
    networks:
      - blog-network
    healthcheck:
      test: |
        bash -c '
          if ! mongosh --quiet --eval "rs.status()" > /dev/null 2>&1; then
            mongosh --eval "rs.initiate({_id: "rs0", members: [{_id: 0, host: "mongodb:27017"}]})" > /dev/null 2>&1 || true
          fi
          echo "db.runCommand("ping").ok" | mongosh --quiet
        '
      interval: 5s
      timeout: 30s
      start_period: 10s
      retries: 30

  # DynamoDB Local
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: blog-api-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    volumes:
      - dynamodb-data:/home/dynamodblocal/data
    working_dir: /home/dynamodblocal
    restart: unless-stopped
    networks:
      - blog-network

  # Aplicação Blog API (com inicialização automática)
  blog-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: blog-api
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      HOST: 0.0.0.0
      
      # MongoDB Config
      DATABASE_PROVIDER: PRISMA
      DATABASE_URL: "mongodb://mongodb:27017/rainer-portfolio?replicaSet=rs0"
      MONGODB_DB_NAME: rainer-portfolio
      
      # DynamoDB Config
      DYNAMODB_ENDPOINT: http://dynamodb-local:8000
      DYNAMODB_TABLE_PREFIX: blog
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      
      # JWT Config
      JWT_SECRET: 1vLG1UVpIFyhWLWubWc4Vuo3S3ritN9t/B9arxjKRL2aMGeiZM2gOx22Z+czY1amLEbvxCoMbH9x1G1ufpA+yg==
      JWT_EXPIRES_IN: 7d
      
      # Cognito Config
      COGNITO_USER_POOL_ID: us-east-1_wryiyhbWC
      COGNITO_CLIENT_ID: 3ueos5ofu499je6ebc5u98n35h
      COGNITO_REGION: us-east-1
      COGNITO_ISSUER: https://cognito-idp.us-east-1.amazonaws.com/us-east-1_wryiyhbWC
      
      # Cloudinary (opcional)
      CLOUDINARY_URL: cloudinary://dummy
      
      # CORS
      CORS_ORIGIN: "*"
      LOG_LEVEL: info
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - blog-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    volumes:
      - ./logs:/app/logs

  # Prisma Studio (opcional, para desenvolvimento)
  prisma-studio:
    image: timothyjmiller/prisma-studio:latest
    container_name: blog-api-studio
    ports:
      - "5555:5555"
    environment:
      PRISMA_SCHEMA_PATH: /prisma/schema.prisma
      DATABASE_URL: "mongodb://mongodb:27017/rainer-portfolio?replicaSet=rs0"
    volumes:
      - ./src/database/mongodb/prisma:/prisma
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - blog-network
    profiles:
      - dev

  # DynamoDB Admin (opcional, para desenvolvimento)
  dynamodb-admin:
    image: node:20-alpine
    container_name: blog-api-dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      DYNAMO_ENDPOINT: http://dynamodb-local:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
    command: >
      sh -c "
        npm install -g dynamodb-admin &&
        dynamodb-admin
      "
    depends_on:
      blog-api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - blog-network
    profiles:
      - dev

volumes:
  mongodb-data:
    name: blog-api-mongodb-data
  mongodb-config:
    name: blog-api-mongodb-config
  dynamodb-data:
    name: blog-api-dynamodb-data
  prisma-node-modules:
    name: blog-api-prisma-node-modules

networks:
  blog-network:
    name: blog-api-network
    driver: bridge