services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    image: rainer-backend:latest
    container_name: rainer-backend-api
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      HOST: 0.0.0.0
      DATABASE_URL: "mongodb://mongodb:27017/rainer-portfolio?replicaSet=rs0"
      DYNAMODB_ENDPOINT: http://dynamodb:8000
      DATABASE_PROVIDER: "DYNAMODB"
      USE_DYNAMODB: "true"
      CORS_ORIGIN: "*"
      LOG_LEVEL: "info"
    depends_on:
      mongodb:
        condition: service_healthy
      dynamodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mongodb:
    image: mongo:8.0
    container_name: rainer-backend-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: rainer-portfolio
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped
    networks:
      - backend-network
    healthcheck:
      test: mongosh --eval "db.adminCommand ping" localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  dynamodb:
    image: amazon/dynamodb-local:2.5.1
    container_name: rainer-backend-dynamodb
    ports:
      - "8000:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    volumes:
      - dynamodb_data:/home/dynamodblocal/data
    restart: unless-stopped
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/shard/"]
      interval: 10s
      timeout: 5s
      retries: 5

  dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    container_name: rainer-backend-dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      DYNAMO_ENDPOINT: http://dynamodb:8000
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
    depends_on:
      dynamodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend-network

volumes:
  mongodb_data:
    driver: local
  dynamodb_data:
    driver: local

networks:
  backend-network:
    driver: bridge
