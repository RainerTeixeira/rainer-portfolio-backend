# ═══════════════════════════════════════════════════════════════════════════════
# RAINER PORTFOLIO BACKEND - Docker Compose
# ═══════════════════════════════════════════════════════════════════════════════
# Configuração otimizada para desenvolvimento local simulando ambiente AWS
#
# USO RÁPIDO:
#   docker compose up -d    # Sobe TODOS os serviços
#   docker compose down     # Para todos os containers
#   pnpm dev                 # Roda o backend (usa .env do projeto)
#
# PORTAS:
#   4000  - Backend Node.js
#   8000  - DynamoDB Local
#   8001  - DynamoDB Admin UI
#   27017 - MongoDB
#   5555  - Prisma Studio
# ═══════════════════════════════════════════════════════════════════════════════

name: rainer-blog-backend

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # RAINER PORTFOLIO BACKEND - Aplicação Node.js
  # ─────────────────────────────────────────────────────────────────────────────
  rainer-blog-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rainer-blog-backend-api
    ports:
      - "4000:4000"
    env_file:
      - .env
    environment:
      HOST: 0.0.0.0
      PORT: 4000
      DATABASE_URL: "mongodb://mongodb:27017/${MONGODB_DB_NAME:-rainer-portfolio}?replicaSet=rs0"
      DYNAMODB_ENDPOINT: http://dynamodb-local:8000
      PRISMA_GENERATE_ON_START: "false"
      RUN_SEED: "false"
      USE_DYNAMODB: "false"
    depends_on:
      dynamodb-local:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend-network
    volumes:
      - ./logs:/app/logs

  # ─────────────────────────────────────────────────────────────────────────────
  # DYNAMODB LOCAL - Simula AWS DynamoDB (SERVIÇO PRINCIPAL)
  # ─────────────────────────────────────────────────────────────────────────────
  dynamodb-local:
    image: amazon/dynamodb-local:2.5.3
    container_name: rainer-blog-backend-dynamodb
    ports:
      - "8000:8000"
    command: -jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal/data
    user: root
    restart: unless-stopped
    networks:
      - backend-network
    volumes:
      - dynamodb-data:/home/dynamodblocal/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null http://localhost:8000/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ─────────────────────────────────────────────────────────────────────────────
  # DYNAMODB ADMIN UI - Interface visual para DynamoDB (opcional)
  # ─────────────────────────────────────────────────────────────────────────────
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    container_name: rainer-blog-backend-dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      DYNAMO_ENDPOINT: http://dynamodb-local:8000
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${DYNAMODB_ACCESS_KEY_ID:-dummy}
      AWS_SECRET_ACCESS_KEY: ${DYNAMODB_SECRET_ACCESS_KEY:-dummy}
    depends_on:
      dynamodb-local:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          memory: 128M

  # ─────────────────────────────────────────────────────────────────────────────
  # MONGODB - Alternativa ao DynamoDB (opcional, para testes com Prisma)
  # ─────────────────────────────────────────────────────────────────────────────
  mongodb:
    image: mongo:7.0-jammy
    container_name: rainer-blog-backend-mongodb
    ports:
      - "27017:27017"
    command: mongod --replSet rs0 --bind_ip_all
    environment:
      MONGO_INITDB_DATABASE: ${MONGODB_DB_NAME:-rainer-portfolio}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    restart: unless-stopped
    networks:
      - backend-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ─────────────────────────────────────────────────────────────────────────────
  # PRISMA STUDIO - Interface visual para MongoDB (opcional)
  # ─────────────────────────────────────────────────────────────────────────────
  prisma-studio:
    image: timothyjmiller/prisma-studio:latest
    container_name: rainer-blog-backend-prisma-studio
    ports:
      - "5555:5555"
    environment:
      PRISMA_SCHEMA_PATH: /prisma/schema.prisma
      DATABASE_URL: "mongodb://mongodb:27017/${MONGODB_DB_NAME:-rainer-portfolio}?replicaSet=rs0"
    volumes:
      - ./src/database/mongodb/prisma:/prisma:ro
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          memory: 256M

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES - Persistência de dados
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  dynamodb-data:
    name: rainer-blog-backend-dynamodb-data
  mongodb-data:
    name: rainer-blog-backend-mongodb-data
  mongodb-config:
    name: rainer-blog-backend-mongodb-config

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS - Rede isolada para os serviços
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  backend-network:
    name: rainer-blog-backend-network
    driver: bridge