# üîÑ Workflow: Desenvolvimento Local ‚Üí Deploy AWS

**Guia completo** para testar localmente e depois fazer deploy na AWS com **custo ZERO**.

---

## üéØ **Vis√£o Geral do Workflow**

```
1. üè† Desenvolvimento Local (MongoDB + Prisma)
          ‚Üì
2. üß™ Teste Local (DynamoDB Local)
          ‚Üì
3. ‚òÅÔ∏è  Deploy AWS (DynamoDB AWS - Free Tier)
          ‚Üì
4. üéâ Produ√ß√£o (R$ 0,00/m√™s)
```

---

## 1Ô∏è‚É£ **FASE 1: Desenvolvimento R√°pido (MongoDB + Prisma)**

### **Por que come√ßar com MongoDB?**

- ‚úÖ Mais r√°pido para desenvolver (Prisma ORM)
- ‚úÖ Relacionamentos autom√°ticos
- ‚úÖ Migrations f√°ceis
- ‚úÖ Type-safe completo
- ‚úÖ Prisma Studio (GUI visual)

### **Configura√ß√£o (.env)**

```bash
# Banco de dados
DATABASE_PROVIDER=PRISMA
DATABASE_URL="mongodb://localhost:27017/blog?replicaSet=rs0&directConnection=true"

# AWS (n√£o usado ainda, mas pode deixar)
AWS_REGION=us-east-1
DYNAMODB_TABLE_PREFIX=blog
```

### **Setup**

```bash
# 1. Iniciar MongoDB
docker-compose up -d mongodb

# 2. Aguardar Replica Set (15s)
timeout /t 15

# 3. Gerar Prisma Client
npm run prisma:generate

# 4. Sincronizar schema
npm run prisma:push

# 5. Popular com dados
npm run seed

# 6. Rodar aplica√ß√£o
npm run dev
```

### **Testar**

```bash
# Health check
curl http://localhost:4000/health \
  -H "X-Database-Provider: PRISMA"

# Deve retornar:
{
  "database": {
    "provider": "PRISMA",
    "description": "MongoDB + Prisma (Local)"
  }
}

# Listar posts
curl http://localhost:4000/posts \
  -H "X-Database-Provider: PRISMA"
```

### **Verificar Dados (GUI)**

```bash
npm run prisma:studio

# Abre http://localhost:5555
# Interface visual para ver/editar dados
```

---

## 2Ô∏è‚É£ **FASE 2: Teste com DynamoDB Local**

### **Por que testar com DynamoDB Local?**

- ‚úÖ Simula AWS antes de fazer deploy
- ‚úÖ Testa se c√≥digo funciona com DynamoDB
- ‚úÖ Identifica problemas antes da nuvem
- ‚úÖ Gr√°tis, sem custo AWS
- ‚úÖ Offline

### **Configura√ß√£o (.env)**

```bash
# Trocar para DynamoDB
DATABASE_PROVIDER=DYNAMODB

# MongoDB (manter para compara√ß√£o)
DATABASE_URL="mongodb://localhost:27017/blog?replicaSet=rs0&directConnection=true"

# DynamoDB Local
DYNAMODB_ENDPOINT=http://localhost:8000  # ‚Üê Chave para detec√ß√£o!
DYNAMODB_TABLE_PREFIX=blog
AWS_REGION=us-east-1
```

### **Setup**

```bash
# 1. Manter MongoDB rodando (para comparar)
# docker-compose up -d mongodb  # J√° est√° rodando

# 2. Iniciar DynamoDB Local
docker-compose up -d dynamodb-local

# 3. Aguardar inicializa√ß√£o (5s)
timeout /t 5

# 4. Criar tabelas DynamoDB
npm run dynamodb:create-tables

# Sa√≠da esperada:
# üóÑÔ∏è CRIANDO TABELAS NO DYNAMODB LOCAL
# üí∞ Billing Mode: Provisioned (FREE TIER PERMANENTE)
# ‚ö° Capacidade Total: 25 RCU + 25 WCU
# ‚úÖ 7 tabelas criadas!

# 5. Popular DynamoDB
npm run dynamodb:seed

# 6. Rodar aplica√ß√£o (mesma porta!)
npm run dev
```

### **Testar com DynamoDB Local**

```bash
# Health check DynamoDB
curl http://localhost:4000/health \
  -H "X-Database-Provider: DYNAMODB"

# Deve retornar:
{
  "database": {
    "provider": "DYNAMODB",
    "description": "DynamoDB Local (Desenvolvimento)",
    "dynamodbEnvironment": "LOCAL"
  }
}

# Listar posts do DynamoDB
curl http://localhost:4000/posts \
  -H "X-Database-Provider: DYNAMODB"

# Comparar com Prisma
curl http://localhost:4000/posts \
  -H "X-Database-Provider: PRISMA"
```

### **Comparar Resultados**

```bash
# Mesma aplica√ß√£o, 2 bancos diferentes!
# Alterne o header X-Database-Provider para comparar
```

---

## 3Ô∏è‚É£ **FASE 3: Deploy AWS (Produ√ß√£o - Free Tier)**

### **Por que fazer deploy?**

- ‚úÖ Alta disponibilidade (SLA 99.99%)
- ‚úÖ Escala autom√°tica
- ‚úÖ Sem servidor para gerenciar
- ‚úÖ **Custo ZERO** (Free Tier permanente)

### **Configura√ß√£o (.env.production)**

```bash
# N√ÉO usar .env em produ√ß√£o!
# CloudFormation/SAM configura automaticamente

# Vari√°veis definidas no template.yaml:
# DATABASE_PROVIDER=DYNAMODB (autom√°tico)
# AWS_REGION=us-east-1 (autom√°tico)
# DYNAMODB_TABLE_PREFIX=blog-prod (autom√°tico)
# DYNAMODB_ENDPOINT=(vazio - usa AWS!) ‚Üê Chave!
```

### **Pr√©-requisitos**

```bash
# 1. AWS CLI configurado
aws configure

# Informar:
# - AWS Access Key ID
# - AWS Secret Access Key  
# - Region: us-east-1
# - Output: json

# 2. Verificar conta
aws sts get-caller-identity

# Deve retornar seu User ID

# 3. SAM CLI instalado
sam --version

# Deve retornar: SAM CLI, version 1.x.x
```

### **Deploy**

```bash
# 1. Build da aplica√ß√£o
cd src/lambda
sam build

# Sa√≠da:
# Building codeuri: ../../
# Running NodejsNpmBuilder:NpmPack
# Build Succeeded

# 2. Deploy pela primeira vez (guided)
sam deploy --guided

# Responder:
# Stack Name: blog-backend-api
# AWS Region: us-east-1
# Parameter Environment: prod
# Confirm changes before deploy: Y
# Allow SAM CLI IAM role creation: Y
# Save arguments to configuration file: Y

# 3. Deploy futuro (autom√°tico)
sam deploy --config-env prod
```

### **O que √© Criado na AWS**

```
Stack CloudFormation: blog-backend-api
‚îú‚îÄ‚îÄ 1√ó Lambda Function (Node.js 20)
‚îÇ   ‚îú‚îÄ‚îÄ Memory: 512 MB
‚îÇ   ‚îú‚îÄ‚îÄ Timeout: 30s
‚îÇ   ‚îî‚îÄ‚îÄ Function URL (endpoint HTTP)
‚îÇ
‚îú‚îÄ‚îÄ 7√ó DynamoDB Tables (25 RCU/WCU total)
‚îÇ   ‚îú‚îÄ‚îÄ blog-prod-users (5 RCU/WCU)
‚îÇ   ‚îú‚îÄ‚îÄ blog-prod-posts (5 RCU/WCU)
‚îÇ   ‚îú‚îÄ‚îÄ blog-prod-categories (3 RCU/WCU)
‚îÇ   ‚îú‚îÄ‚îÄ blog-prod-comments (3 RCU/WCU)
‚îÇ   ‚îú‚îÄ‚îÄ blog-prod-likes (3 RCU/WCU)
‚îÇ   ‚îú‚îÄ‚îÄ blog-prod-bookmarks (3 RCU/WCU)
‚îÇ   ‚îî‚îÄ‚îÄ blog-prod-notifications (3 RCU/WCU)
‚îÇ
‚îú‚îÄ‚îÄ 16√ó Global Secondary Indexes
‚îÇ
‚îú‚îÄ‚îÄ 1√ó CloudWatch Log Group
‚îÇ   ‚îî‚îÄ‚îÄ Reten√ß√£o: 30 dias
‚îÇ
‚îî‚îÄ‚îÄ 1√ó IAM Role (para Lambda)

üí∞ Custo Total: R$ 0,00 (Free Tier permanente)
```

### **Obter URL da API**

```bash
# Ver outputs do CloudFormation
aws cloudformation describe-stacks \
  --stack-name blog-backend-api \
  --query 'Stacks[0].Outputs'

# Ou via SAM
sam list stack-outputs --stack-name blog-backend-api

# Copiar o BlogApiFunctionUrl
```

### **Testar na AWS**

```bash
# URL retornada pelo comando acima
export API_URL="https://xyz.lambda-url.us-east-1.on.aws"

# Health check
curl $API_URL/health

# Listar posts
curl $API_URL/posts

# Criar post (precisa auth Cognito)
curl -X POST $API_URL/posts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SEU_TOKEN_COGNITO" \
  -d '{
    "title": "Meu Post",
    "slug": "meu-post",
    "content": {...},
    "subcategoryId": "..."
  }'
```

---

## üîÑ **Compara√ß√£o dos 3 Ambientes**

| Aspecto | MongoDB Local | DynamoDB Local | AWS DynamoDB |
|---------|---------------|----------------|--------------|
| **Banco** | MongoDB | DynamoDB | DynamoDB |
| **ORM** | Prisma | AWS SDK | AWS SDK |
| **Endpoint** | localhost:27017 | localhost:8000 | AWS Cloud |
| **Detec√ß√£o** | `DATABASE_PROVIDER=PRISMA` | `DYNAMODB_ENDPOINT=...` | Sem `DYNAMODB_ENDPOINT` |
| **Setup** | Docker Compose | Docker Compose | CloudFormation |
| **Custo** | R$ 0 | R$ 0 | R$ 0 (Free Tier) |
| **Performance** | Boa | Boa | Excelente |
| **Escalabilidade** | Limitada | Limitada | Infinita |
| **Uso** | Desenvolvimento | Testes pr√©-deploy | Produ√ß√£o |

---

## üìã **Checklist Completo**

### **Fase 1: Desenvolvimento Local** üè†

- [ ] MongoDB rodando (`docker ps`)
- [ ] Prisma Client gerado (`npm run prisma:generate`)
- [ ] Schema sincronizado (`npm run prisma:push`)
- [ ] Dados populados (`npm run seed`)
- [ ] API rodando (`npm run dev`)
- [ ] Testes passando (`npm test`)
- [ ] Swagger funcionando (`http://localhost:4000/docs`)
- [ ] Todas as rotas testadas

### **Fase 2: Teste DynamoDB Local** üß™

- [ ] DynamoDB Local rodando (`docker ps`)
- [ ] Tabelas criadas (`npm run dynamodb:create-tables`)
- [ ] Dados populados (`npm run dynamodb:seed`)
- [ ] API rodando (`npm run dev`)
- [ ] Header `X-Database-Provider: DYNAMODB` funciona
- [ ] Comparar resultados com MongoDB
- [ ] Performance aceit√°vel
- [ ] Sem erros de throttling

### **Fase 3: Deploy AWS** ‚òÅÔ∏è

- [ ] AWS CLI configurado (`aws configure`)
- [ ] SAM CLI instalado (`sam --version`)
- [ ] Build bem-sucedido (`sam build`)
- [ ] Deploy bem-sucedido (`sam deploy`)
- [ ] 7 tabelas criadas na AWS
- [ ] Lambda Function URL obtida
- [ ] Health check funcionando
- [ ] Cognito configurado
- [ ] Custo = $0.00 (`aws ce get-cost-and-usage`)

---

## üõ†Ô∏è **Scripts √öteis**

### **Alternar entre Bancos Localmente**

```bash
# Script j√° existe!
.\scripts\alternar-banco.bat

# Ou manual:
# Para MongoDB
echo DATABASE_PROVIDER=PRISMA > .env

# Para DynamoDB Local
echo DATABASE_PROVIDER=DYNAMODB >> .env
echo DYNAMODB_ENDPOINT=http://localhost:8000 >> .env
```

### **Comparar Dados**

```bash
# MongoDB
curl http://localhost:4000/users \
  -H "X-Database-Provider: PRISMA" \
  | jq length

# DynamoDB Local
curl http://localhost:4000/users \
  -H "X-Database-Provider: DYNAMODB" \
  | jq length

# Devem retornar o mesmo n√∫mero!
```

### **Limpar Tudo e Recome√ßar**

```bash
# Limpar MongoDB
npm run prisma:push --force-reset

# Limpar DynamoDB Local
docker restart blogapi-dynamodb
npm run dynamodb:create-tables
npm run dynamodb:seed
```

---

## üöÄ **Migra√ß√£o Completa: Local ‚Üí AWS**

### **Passo a Passo Detalhado**

#### **Semana 1-2: Desenvolvimento**

```bash
# Use MongoDB + Prisma
DATABASE_PROVIDER=PRISMA

# Desenvolva todas as features
# Teste unit√°rio + integra√ß√£o
# Valide no Swagger
```

#### **Semana 3: Prepara√ß√£o**

```bash
# 1. Teste com DynamoDB Local
DATABASE_PROVIDER=DYNAMODB
DYNAMODB_ENDPOINT=http://localhost:8000

# 2. Criar tabelas
npm run dynamodb:create-tables

# 3. Popular dados
npm run dynamodb:seed

# 4. Testar TODAS as rotas
# Use header: X-Database-Provider: DYNAMODB

# 5. Validar que funciona igual ao Prisma
```

#### **Semana 4: Deploy**

```bash
# 1. Configurar AWS
aws configure

# 2. Build
cd src/lambda
sam build

# 3. Deploy
sam deploy --guided

# 4. Obter URL
sam list stack-outputs

# 5. Testar
curl https://sua-url.lambda-url.us-east-1.on.aws/health

# 6. Configurar Cognito (se ainda n√£o tiver)
# Ver: docs/03-GUIAS/GUIA_INTEGRACAO_AUTH.md

# 7. Monitorar custos
aws ce get-cost-and-usage --time-period Start=2025-10-01,End=2025-10-31 --granularity MONTHLY --metrics BlendedCost

# Deve mostrar: $0.00 ‚úÖ
```

---

## üéØ **Valida√ß√£o de Compatibilidade**

### **Antes de Fazer Deploy**

Garanta que **TODAS** as rotas funcionam localmente com DynamoDB:

```bash
# Use o script de teste de rotas!
.\scripts\testar-todas-rotas.ps1

# Ou teste manual cada categoria:

# Health
curl http://localhost:4000/health -H "X-Database-Provider: DYNAMODB"

# Usu√°rios
curl http://localhost:4000/users -H "X-Database-Provider: DYNAMODB"

# Posts
curl http://localhost:4000/posts -H "X-Database-Provider: DYNAMODB"

# Categorias
curl http://localhost:4000/categories -H "X-Database-Provider: DYNAMODB"

# Coment√°rios (por post)
curl http://localhost:4000/comments/post/{postId} -H "X-Database-Provider: DYNAMODB"

# Likes (por post)
curl http://localhost:4000/likes/post/{postId} -H "X-Database-Provider: DYNAMODB"

# Bookmarks (por usu√°rio)
curl http://localhost:4000/bookmarks/user/{userId} -H "X-Database-Provider: DYNAMODB"

# Notifica√ß√µes (por usu√°rio)
curl http://localhost:4000/notifications/user/{userId} -H "X-Database-Provider: DYNAMODB"
```

**Todas devem funcionar!** ‚úÖ

---

## üí∞ **Monitoramento de Custos**

### **Durante Desenvolvimento Local**

```
MongoDB: R$ 0,00 (Docker local)
DynamoDB Local: R$ 0,00 (Docker local)
Custo total: R$ 0,00 ‚úÖ
```

### **Ap√≥s Deploy AWS**

```bash
# Verificar a cada semana
aws ce get-cost-and-usage \
  --time-period Start=$(date -d '7 days ago' +%Y-%m-%d),End=$(date +%Y-%m-%d) \
  --granularity DAILY \
  --metrics BlendedCost \
  --group-by Type=SERVICE

# Configurar alarme de custo
aws budgets create-budget \
  --account-id $(aws sts get-caller-identity --query Account --output text) \
  --budget '{
    "BudgetName": "blog-api-budget",
    "BudgetLimit": {
      "Amount": "1",
      "Unit": "USD"
    },
    "TimeUnit": "MONTHLY",
    "BudgetType": "COST"
  }' \
  --notifications-with-subscribers '[{
    "Notification": {
      "NotificationType": "ACTUAL",
      "ComparisonOperator": "GREATER_THAN",
      "Threshold": 0.5
    },
    "Subscribers": [{
      "SubscriptionType": "EMAIL",
      "Address": "seu-email@example.com"
    }]
  }]'
```

---

## üîß **Troubleshooting**

### **Problema: API funciona com PRISMA mas falha com DYNAMODB**

**Causa**: Dados n√£o foram populados ou tabelas n√£o foram criadas.

**Solu√ß√£o**:

```bash
# Verificar se DynamoDB Local est√° rodando
docker ps | grep dynamodb

# Recriar tabelas
docker restart blogapi-dynamodb
npm run dynamodb:create-tables
npm run dynamodb:seed

# Testar novamente
curl http://localhost:4000/health -H "X-Database-Provider: DYNAMODB"
```

### **Problema: Deploy AWS retorna erro de permiss√£o**

**Causa**: IAM n√£o tem permiss√µes suficientes.

**Solu√ß√£o**:

```bash
# Verificar permiss√µes
aws iam get-user

# Adicionar pol√≠tica de CloudFormation
aws iam attach-user-policy \
  --user-name seu-usuario \
  --policy-arn arn:aws:iam::aws:policy/AWSCloudFormationFullAccess
```

### **Problema: Custo > $0.00 ap√≥s deploy**

**Causa**: Algo saiu do Free Tier.

**Solu√ß√£o**:

```bash
# Verificar qual servi√ßo est√° cobrando
aws ce get-cost-and-usage \
  --time-period Start=2025-10-01,End=2025-10-31 \
  --granularity MONTHLY \
  --metrics BlendedCost \
  --group-by Type=SERVICE

# Verificar se tabelas est√£o Provisioned
aws dynamodb describe-table --table-name blog-prod-users

# BillingModeSummary deve mostrar: PROVISIONED
```

---

## üìä **Resumo do Workflow**

```mermaid
graph TD
    A[In√≠cio] --> B[MongoDB + Prisma Local]
    B --> C{Desenvolveu tudo?}
    C -->|N√£o| B
    C -->|Sim| D[DynamoDB Local]
    D --> E{Tudo funciona?}
    E -->|N√£o| F[Corrigir c√≥digo]
    F --> D
    E -->|Sim| G[Deploy AWS]
    G --> H{Custo = $0?}
    H -->|Sim| I[Produ√ß√£o ‚úÖ]
    H -->|N√£o| J[Revisar config]
    J --> G
```

---

## ‚úÖ **Checklist Final Antes de Produ√ß√£o**

### **C√≥digo**

- [ ] Todas rotas testadas (59 rotas)
- [ ] Funciona com PRISMA local
- [ ] Funciona com DYNAMODB local
- [ ] Testes unit√°rios passando (>95% coverage)
- [ ] Testes E2E passando
- [ ] Sem warnings no console

### **Seguran√ßa**

- [ ] Cognito configurado
- [ ] JWT validado
- [ ] CORS configurado
- [ ] Rate limiting (se necess√°rio)
- [ ] Valida√ß√£o de inputs (Zod)

### **Performance**

- [ ] Itens DynamoDB ‚â§ 1 KB
- [ ] √çndices GSI corretos
- [ ] Cache configurado (se aplic√°vel)
- [ ] Logs otimizados

### **AWS**

- [ ] Free Tier ativo
- [ ] CloudWatch Alarms configurados
- [ ] Backup configurado (PITR)
- [ ] Monitoramento de custos ativo
- [ ] Budget alert configurado

---

## üéâ **Pronto!**

Agora voc√™ tem:

‚úÖ Ambiente de **desenvolvimento local** r√°pido (MongoDB)  
‚úÖ Ambiente de **teste local** que simula AWS (DynamoDB Local)  
‚úÖ **Deploy AWS** otimizado para Free Tier  
‚úÖ **Custo ZERO** permanente  
‚úÖ **Alta disponibilidade** e escalabilidade  

**Comece desenvolvendo local, teste com DynamoDB Local, e fa√ßa deploy quando estiver pronto!** üöÄ

---

**Criado em**: 17/10/2025  
**Status**: ‚úÖ **Workflow Completo Validado**
