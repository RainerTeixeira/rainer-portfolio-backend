AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Rainer Portfolio Backend - Serverless AWS (Lambda + DynamoDB + Cognito + Function URLs)'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARÃ‚METROS GLOBAIS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Ambiente de deployment (dev, staging ou prod)
  
  DomainName:
    Type: String
    Default: ''
    Description: Custom domain name (optional)
  
  CognitoUserPoolId:
    Type: String
    Description: ID do Cognito User Pool existente
    Default: ''
  
  CognitoClientId:
    Type: String
    Description: ID do Cognito App Client existente
    Default: ''

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONDIÃ‡Ã•ES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Conditions:
  IsProduction: !Equals [!Ref Environment, 'prod']
  IsDevelopment: !Equals [!Ref Environment, 'dev']
  HasDomainName: !Not [!Equals [!Ref DomainName, '']]
  HasCognitoConfig: !And
    - !Not [!Equals [!Ref CognitoUserPoolId, '']]
    - !Not [!Equals [!Ref CognitoClientId, '']]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIÃVEIS GLOBAIS - OTIMIZADAS PARA FREE TIER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Globals:
  Function:
    # âš¡ Lambda Free Tier: 1M requests + 400k GB-segundos/mÃªs GRÃTIS
    Timeout: 29 # MÃ¡ximo para Function URLs (30s)
    MemorySize: 512 # Sweet spot: performance vs custo
    Runtime: nodejs20.x # Mais recente e eficiente
    Architectures:
      - x86_64 # Free Tier maior que ARM64
    Environment:
      Variables:
        NODE_ENV: !Ref Environment
        DATABASE_PROVIDER: DYNAMODB
        AWS_REGION: !Ref AWS::Region
        DYNAMODB_TABLE_PREFIX: !Sub '${AWS::StackName}-${Environment}'
        LOG_LEVEL: !If [IsProduction, 'warn', 'debug']
        # Cognito (criado dinamicamente ou existente)
        COGNITO_USER_POOL_ID: !If [HasCognitoConfig, !Ref CognitoUserPoolId, !Ref UserPool]
        COGNITO_CLIENT_ID: !If [HasCognitoConfig, !Ref CognitoClientId, !Ref UserPoolClient]
        COGNITO_REGION: !Ref AWS::Region
    # X-Ray grÃ¡tis (1M traces/mÃªs)
    Tracing: !If [IsDevelopment, 'Active', 'PassThrough']
    # Tags para controle de custos
    Tags:
      Environment: !Ref Environment
      Application: blog-api-serverless
      ManagedBy: AWS-SAM
      CostCenter: FreeTier
      Owner: RainerSoft

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RECURSOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Resources:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # COGNITO USER POOL E CLIENT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  # Cognito User Pool
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${AWS::StackName}-users-${Environment}'
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: name
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: nickname
          AttributeDataType: String
          Required: false
          Mutable: true
      LambdaConfig:
        PreSignUp: !GetAtt PreSignUpTrigger.Arn
      Tags:
        Environment: !Ref Environment
        Application: rainer-portfolio-backend

  # Cognito User Pool Client
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: !Sub '${AWS::StackName}-client-${Environment}'
      GenerateSecret: false
      SupportedIdentityProviders:
        - COGNITO
        - Google
        - Facebook
      CallbackURLs:
        - !If 
          - HasDomainName
          - !Sub 'https://${DomainName}/auth/callback'
          - 'http://localhost:3000/auth/callback'
        - 'http://localhost:3000/auth/callback'
      LogoutURLs:
        - !If 
          - HasDomainName
          - !Sub 'https://${DomainName}/auth/logout'
          - 'http://localhost:3000/auth/logout'
        - 'http://localhost:3000/auth/logout'
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH

  # Pre-SignUp Lambda Trigger
  PreSignUpTrigger:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-pre-signup-${Environment}'
      CodeUri: .
      Handler: lambda/cognito-pre-signup-trigger.handler
      Runtime: nodejs20.x
      Timeout: 10
      MemorySize: 256
      Environment:
        Variables:
          NODE_ENV: !Ref Environment
      Tags:
        Environment: !Ref Environment
        Application: rainer-portfolio-backend

  # Permission for Cognito to invoke Pre-SignUp trigger
  PreSignUpTriggerPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PreSignUpTrigger
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # FUNÃ‡ÃƒO LAMBDA - API PRINCIPAL (OTIMIZADA FREE TIER)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BlogApiFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: !If [IsDevelopment, true, false]
        EntryPoints:
          - src/lambda/handler.ts
        External:
          - '@aws-sdk/*' # Usar AWS SDK do runtime
        Bundle: true
        TreeShaking: true
    Properties:
      FunctionName: !Sub '${AWS::StackName}-api-${Environment}'
      Description: 'NestJS Blog API - Serverless com DynamoDB (Free Tier)'
      Handler: handler.lambdaHandler
      CodeUri: .
      
      # ConfiguraÃ§Ãµes de performance
      ReservedConcurrencyLimit: !If [IsProduction, 10, 2]
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt DeadLetterQueue.Arn
      
      # Function URL (GRATUITO - sem API Gateway)
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowOrigins: 
            - '*'
          AllowHeaders: 
            - 'Content-Type'
            - 'Authorization' 
            - 'X-Database-Provider'
            - 'X-Requested-With'
          AllowMethods: 
            - 'GET'
            - 'POST'
            - 'PUT'
            - 'PATCH'
            - 'DELETE'
            - 'OPTIONS'
          MaxAge: 86400
          AllowCredentials: false
      
      # PermissÃµes IAM (mÃ­nimas necessÃ¡rias)
      Policies:
        # DynamoDB - Acesso completo Ã s tabelas
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PostsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CommentsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref LikesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref BookmarksTable
        - DynamoDBCrudPolicy:
            TableName: !Ref NotificationsTable
        
        # CloudWatch Logs (Free Tier: 5GB/mÃªs)
        - Statement:
            - Effect: Allow
              Action:
                - 'logs:CreateLogGroup'
                - 'logs:CreateLogStream'
                - 'logs:PutLogEvents'
              Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${AWS::StackName}-api-${Environment}*'
        
        # Cognito (criado dinamicamente ou existente)
        - Statement:
            - Effect: Allow
              Action:
                - 'cognito-idp:AdminGetUser'
                - 'cognito-idp:AdminUpdateUserAttributes'
                - 'cognito-idp:AdminSetUserPassword'
                - 'cognito-idp:ListUsers'
                - 'cognito-idp:AdminCreateUser'
                - 'cognito-idp:AdminDeleteUser'
              Resource: !If 
                - HasCognitoConfig
                - !Sub 'arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}'
                - !GetAtt UserPool.Arn
      
      # VariÃ¡veis especÃ­ficas da funÃ§Ã£o
      Environment:
        Variables:
          CORS_ORIGIN: '*'
          PORT: '4000'
          HOST: '0.0.0.0'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # TABELAS DYNAMODB
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: USERS (â­ 5 RCU/WCU - Mais Acessada)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-users

      # ğŸ’° FREE TIER PERMANENTE: Provisioned (nÃ£o On-Demand!)
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 5 # â­ Mais acessado (auth)
        WriteCapacityUnits: 5

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: email
          AttributeType: S
        - AttributeName: username
          AttributeType: S
        - AttributeName: cognitoSub
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH

      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

        - IndexName: UsernameIndex
          KeySchema:
            - AttributeName: username
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

        - IndexName: CognitoSubIndex
          KeySchema:
            - AttributeName: cognitoSub
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

      # Backup: grÃ¡tis atÃ© 10 GB (sempre habilitado)
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Users
        - Key: CostOptimization
          Value: FreeTierProvisioned

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: POSTS (â­ 5 RCU/WCU - Mais Acessada)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PostsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-posts

      # ğŸ’° FREE TIER PERMANENTE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 5 # â­ Mais acessado (feed, listagens)
        WriteCapacityUnits: 5

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: slug
          AttributeType: S
        - AttributeName: authorId
          AttributeType: S
        - AttributeName: subcategoryId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH

      GlobalSecondaryIndexes:
        - IndexName: SlugIndex
          KeySchema:
            - AttributeName: slug
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

        - IndexName: AuthorIndex
          KeySchema:
            - AttributeName: authorId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

        - IndexName: SubcategoryIndex
          KeySchema:
            - AttributeName: subcategoryId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 5
            WriteCapacityUnits: 5

      # Backup: apenas produÃ§Ã£o
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Posts
        - Key: CostOptimization
          Value: FreeTierProvisioned

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: CATEGORIES (3 RCU/WCU)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CategoriesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-categories

      # ğŸ’° FREE TIER PERMANENTE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 3 # NavegaÃ§Ã£o frequente
        WriteCapacityUnits: 3

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: slug
          AttributeType: S
        - AttributeName: parentId
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH

      GlobalSecondaryIndexes:
        - IndexName: SlugIndex
          KeySchema:
            - AttributeName: slug
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

        - IndexName: ParentIdIndex
          KeySchema:
            - AttributeName: parentId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Categories
        - Key: CostOptimization
          Value: FreeTierProvisioned

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: COMMENTS (3 RCU/WCU)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CommentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-comments

      # ğŸ’° FREE TIER PERMANENTE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 3 # InteraÃ§Ãµes mÃ©dias
        WriteCapacityUnits: 3

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: postId
          AttributeType: S
        - AttributeName: authorId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH

      GlobalSecondaryIndexes:
        - IndexName: PostIndex
          KeySchema:
            - AttributeName: postId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

        - IndexName: AuthorIndex
          KeySchema:
            - AttributeName: authorId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Comments

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: LIKES (3 RCU/WCU)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  LikesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-likes

      # ğŸ’° FREE TIER PERMANENTE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 3 # Curtidas frequentes
        WriteCapacityUnits: 3

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: postId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH

      GlobalSecondaryIndexes:
        - IndexName: PostIndex
          KeySchema:
            - AttributeName: postId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

        - IndexName: UserIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Likes
        - Key: CostOptimization
          Value: FreeTierProvisioned

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: BOOKMARKS (3 RCU/WCU)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  BookmarksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-bookmarks

      # ğŸ’° FREE TIER PERMANENTE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 3 # Salvamentos mÃ©dios
        WriteCapacityUnits: 3

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: postId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: PostIndex
          KeySchema:
            - AttributeName: postId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

        - IndexName: UserIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Bookmarks
        - Key: CostOptimization
          Value: FreeTierProvisioned

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TABELA: NOTIFICATIONS (3 RCU/WCU)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  NotificationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-${Environment}-notifications

      # ğŸ’° FREE TIER PERMANENTE
      BillingMode: PROVISIONED
      ProvisionedThroughput:
        ReadCapacityUnits: 3 # NotificaÃ§Ãµes mÃ©dias
        WriteCapacityUnits: 3

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH

      GlobalSecondaryIndexes:
        - IndexName: UserIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 3
            WriteCapacityUnits: 3

      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Resource
          Value: Notifications
        - Key: CostOptimization
          Value: FreeTierProvisioned

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # RECURSOS AUXILIARES
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  # Dead Letter Queue para funÃ§Ãµes com falha
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-dlq-${Environment}'
      MessageRetentionPeriod: 1209600 # 14 dias
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Purpose
          Value: DeadLetterQueue
  
  # CloudWatch Log Group (Free Tier: 5GB/mÃªs)
  BlogApiLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-api-${Environment}'
      RetentionInDays: !If [IsProduction, 30, 7]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: CostOptimization
          Value: FreeTierLogs

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OUTPUTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Outputs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OUTPUTS PRINCIPAIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # Cognito Outputs
  UserPoolId:
    Description: 'Cognito User Pool ID'
    Value: !If [HasCognitoConfig, !Ref CognitoUserPoolId, !Ref UserPool]
    Export:
      Name: !Sub '${AWS::StackName}-user-pool-id'

  UserPoolClientId:
    Description: 'Cognito User Pool Client ID'
    Value: !If [HasCognitoConfig, !Ref CognitoClientId, !Ref UserPoolClient]
    Export:
      Name: !Sub '${AWS::StackName}-user-pool-client-id'

  # API Endpoint
  BlogApiFunctionUrl:
    Description: 'URL pÃºblica da API (Lambda Function URL)'
    Value: !GetAtt BlogApiFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-api-url'

  BlogApiFunctionArn:
    Description: 'ARN da funÃ§Ã£o Lambda principal'
    Value: !GetAtt BlogApiFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-api-arn'
  
  # InformaÃ§Ãµes de deployment
  DeploymentInfo:
    Description: 'InformaÃ§Ãµes do deployment'
    Value: !Sub |
      Stack: ${AWS::StackName}
      Environment: ${Environment}
      Region: ${AWS::Region}
      Deployed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
      API URL: ${BlogApiFunctionUrl.FunctionUrl}

  # Tabelas DynamoDB
  UsersTableName:
    Description: Nome da tabela de usuÃ¡rios
    Value: !Ref UsersTable
    Export:
      Name: !Sub ${AWS::StackName}-users-table

  PostsTableName:
    Description: Nome da tabela de posts
    Value: !Ref PostsTable
    Export:
      Name: !Sub ${AWS::StackName}-posts-table

  CategoriesTableName:
    Description: Nome da tabela de categorias
    Value: !Ref CategoriesTable
    Export:
      Name: !Sub ${AWS::StackName}-categories-table

  CommentsTableName:
    Description: Nome da tabela de comentÃ¡rios
    Value: !Ref CommentsTable
    Export:
      Name: !Sub ${AWS::StackName}-comments-table

  LikesTableName:
    Description: Nome da tabela de likes
    Value: !Ref LikesTable
    Export:
      Name: !Sub ${AWS::StackName}-likes-table

  BookmarksTableName:
    Description: Nome da tabela de bookmarks
    Value: !Ref BookmarksTable
    Export:
      Name: !Sub ${AWS::StackName}-bookmarks-table

  NotificationsTableName:
    Description: Nome da tabela de notificaÃ§Ãµes
    Value: !Ref NotificationsTable
    Export:
      Name: !Sub ${AWS::StackName}-notifications-table

  # InformaÃ§Ãµes de deployment
  StackName:
    Description: Nome da stack CloudFormation
    Value: !Ref AWS::StackName

  Region:
    Description: RegiÃ£o AWS onde a stack foi deployada
    Value: !Ref AWS::Region

  # ğŸ’° RESUMO FREE TIER (CUSTO ZERO PERMANENTE)
  FreeTierSummary:
    Description: 'Resumo completo do Free Tier AWS - Custo ZERO permanente'
    Value: !Sub |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ’° AWS FREE TIER PERMANENTE - CUSTO R$ 0,00 PARA SEMPRE!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸš€ STACK DEPLOYADA:
         â€¢ Nome: ${AWS::StackName}
         â€¢ Ambiente: ${Environment}
         â€¢ RegiÃ£o: ${AWS::Region}
         â€¢ API URL: ${BlogApiFunctionUrl.FunctionUrl}
      
      ğŸ“Š DYNAMODB PROVISIONED (7 tabelas):
         â­ Users: 5 RCU + 5 WCU (autenticaÃ§Ã£o)
         â­ Posts: 5 RCU + 5 WCU (feed principal)
         ğŸ“„ Categories: 3 RCU + 3 WCU (navegaÃ§Ã£o)
         ğŸ’¬ Comments: 3 RCU + 3 WCU (interaÃ§Ãµes)
         â¤ï¸  Likes: 3 RCU + 3 WCU (curtidas)
         ğŸ”– Bookmarks: 3 RCU + 3 WCU (salvamentos)
         ğŸ”” Notifications: 3 RCU + 3 WCU (notificaÃ§Ãµes)
         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         TOTAL: 25 RCU + 25 WCU = 100% GRÃTIS SEMPRE! âœ…
      
      âš¡ AWS LAMBDA:
         â€¢ 1 milhÃ£o requests/mÃªs = GRÃTIS
         â€¢ 400k GB-segundos compute = GRÃTIS
         â€¢ Runtime: Node.js 20.x (x86_64)
         â€¢ Function URLs: 100% GRÃTIS (sem API Gateway)
      
      ğŸ” COGNITO USER POOL:
         â€¢ 50.000 MAU (usuÃ¡rios ativos/mÃªs) = GRÃTIS
      
      ğŸ“ CLOUDWATCH LOGS:
         â€¢ 5 GB ingest/mÃªs = GRÃTIS
         â€¢ RetenÃ§Ã£o: ${Environment} = ${RetentionInDays} dias
      
      ğŸ›¡ï¸ DICAS PARA MANTER FREE TIER:
         1. Itens DynamoDB â‰¤ 1KB (write) / â‰¤ 4KB (read)
         2. Use CloudFront para cache (reduz RCU)
         3. Imagens no S3, metadados no DynamoDB
         4. Configure CloudWatch Alarms para monitorar
         5. Monitore usage no AWS Cost Explorer
      
      âš ï¸ LIMITES IMPORTANTES:
         â€¢ DynamoDB: 25 RCU + 25 WCU (nÃ£o exceder!)
         â€¢ Lambda: 1M requests + 400k GB-segundos/mÃªs
         â€¢ CloudWatch: 5GB logs/mÃªs
         â€¢ Cognito: 50k MAU/mÃªs
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Environment:
    Description: Ambiente de deployment
    Value: !Ref Environment