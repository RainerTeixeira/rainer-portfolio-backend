import type { PreSignUpTriggerHandler } from 'aws-lambda';

export interface PreSignUpEvent {
  version: string;
  region: string;
  userPoolId: string;
  userName: string;
  triggerSource: string;
  request: {
    userAttributes: Record<string, string>;
    validationData?: Record<string, string>;
  };
  response: {
    userAttributes?: Record<string, string>;
    autoConfirmUser?: boolean;
    autoVerifyEmail?: boolean;
    autoVerifyPhone?: boolean;
  };
}

export const handler: PreSignUpTriggerHandler = async (event) => {
  return processPreSignUpEvent(event as PreSignUpEvent);
};

export function processPreSignUpEvent(event: PreSignUpEvent): PreSignUpEvent {
  console.log('Pre-Sign-Up Trigger executed', {
    userName: event.userName,
    userPoolId: event.userPoolId,
    triggerSource: event.triggerSource,
    request: {
      userAttributes: event.request.userAttributes,
    },
  });

  const userAttributes = { ...(event.request.userAttributes || {}) };
  const isSocialLogin = event.triggerSource === 'PreSignUp_ExternalProvider';

  if (isSocialLogin) {
    console.log('Social login detected - configuring attributes automatically');

    if (userAttributes.email && userAttributes.email_verified !== 'true') {
      userAttributes.email_verified = 'true';
      console.log(`Email marked as verified: ${userAttributes.email}`);
    }

    if (!userAttributes.nickname || userAttributes.nickname.trim() === '') {
      let nickname = '';

      if (userAttributes.name) {
        nickname = generateNicknameFromName(userAttributes.name);
      } else if (userAttributes.given_name || userAttributes.family_name) {
        const fullName = [userAttributes.given_name, userAttributes.family_name]
          .filter(Boolean)
          .join(' ');
        nickname = generateNicknameFromName(fullName);
      } else if (userAttributes.preferred_username) {
        nickname = cleanUsernameForNickname(userAttributes.preferred_username);
      } else if (userAttributes.email) {
        nickname = userAttributes.email.split('@')[0]
          .toLowerCase()
          .replace(/[^a-z0-9]/g, '')
          .substring(0, 30);
      }

      if (nickname && nickname.length >= 3) {
        userAttributes.nickname = nickname;
        console.log(`Nickname generated: ${nickname}`);
      }
    }

    if (!userAttributes.preferred_username && userAttributes.nickname) {
      userAttributes.preferred_username = userAttributes.nickname;
    }

    if (!userAttributes.name && (userAttributes.given_name || userAttributes.family_name)) {
      const parts = [
        userAttributes.given_name,
        userAttributes.family_name,
      ].filter(Boolean);
      
      if (parts.length > 0) {
        userAttributes.name = parts.join(' ');
        console.log(`Full name defined: ${userAttributes.name}`);
      }
    }

    console.log('Attributes configured for social login:', {
      email_verified: userAttributes.email_verified,
      nickname: userAttributes.nickname,
      preferred_username: userAttributes.preferred_username,
      name: userAttributes.name,
    });
  } else {
    console.log('Normal signup (not social login) - maintaining default behavior');
  }

  return {
    ...event,
    response: {
      userAttributes: userAttributes,
      autoConfirmUser: isSocialLogin,
      autoVerifyEmail: isSocialLogin,
      autoVerifyPhone: false,
    },
  };
}

function generateNicknameFromName(fullName: string): string {
  if (!fullName || typeof fullName !== 'string') {
    return '';
  }

  const normalized = fullName
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase();

  let nickname = normalized
    .replace(/[^a-z0-9\s]/g, ' ')
    .replace(/\s+/g, '_')
    .replace(/^_+|_+$/g, '')
    .substring(0, parseInt(process.env.NICKNAME_MAX_LENGTH || '30'));

  if (nickname.length < parseInt(process.env.NICKNAME_MIN_LENGTH || '3')) {
    nickname = `${nickname}_${Date.now().toString().slice(-3)}`;
    nickname = nickname.substring(0, parseInt(process.env.NICKNAME_MAX_LENGTH || '30'));
  }

  return nickname;
}

function cleanUsernameForNickname(username: string): string {
  if (!username || typeof username !== 'string') {
    return '';
  }

  const providers = (process.env.SOCIAL_PROVIDERS || 'google,github,facebook,amazon').split(',');
  const pattern = new RegExp(`^(${providers.join('|')})_`, 'i');
  const cleaned = username
    .replace(pattern, '')
    .replace(/[^a-z0-9_]/gi, '')
    .toLowerCase()
    .substring(0, parseInt(process.env.NICKNAME_MAX_LENGTH || '30'));

  if (cleaned.length < parseInt(process.env.NICKNAME_MIN_LENGTH || '3')) {
    return cleaned + '_' + Date.now().toString().slice(-3);
  }

  return cleaned;
}

export default handler;
