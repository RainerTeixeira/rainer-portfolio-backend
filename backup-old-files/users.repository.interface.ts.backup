import { IBaseRepository } from './base.repository.interface';
import { UserRoleType } from '../../modules/users/dto/create-user.dto';

/**
 * Interface do repositório de usuários
 */
export interface IUsersRepository extends IBaseRepository<UserEntity> {
  /**
   * Busca usuário pelo email
   */
  findByEmail(email: string): Promise<UserEntity | null>;

  /**
   * Busca usuário pelo cognitoSub
   */
  findByCognitoSub(cognitoSub: string): Promise<UserEntity | null>;

  /**
   * Lista usuários com paginação
   */
  listUsers(options?: ListUsersOptions): Promise<UserListResult>;

  /**
   * Atualiza perfil do usuário
   */
  updateProfile(userId: string, data: Partial<UserProfile>): Promise<UserEntity>;

  /**
   * Busca múltiplos usuários por IDs
   */
  findByIds(userIds: string[]): Promise<UserEntity[]>;

  /**
   * Conta total de usuários
   */
  countUsers(): Promise<number>;

  /**
   * Incrementa contador de posts do usuário
   */
  incrementPostsCount(userId: string): Promise<void>;

  /**
   * Incrementa contador de comentários do usuário
   */
  incrementCommentsCount(userId: string): Promise<void>;

  /**
   * Atualiza último login do usuário
   */
  updateLastLogin(userId: string): Promise<void>;
}

/**
 * Entidade de usuário no DynamoDB
 */
export interface UserEntity {
  PK: string; // USER#<userId>
  SK: string; // PROFILE
  GSI1PK: string; // USER#<email>
  GSI1SK: string; // PROFILE
  entityType: 'USER';
  createdAt: string;
  updatedAt: string;
  data: {
    id: string;
    cognitoSub: string;
    email: string;
    emailVerified: boolean;
    nickname: string;
    fullName: string;
    avatar?: string;
    bio?: string;
    role: UserRoleType;
    isActive: boolean;
    isBanned: boolean;
    postsCount: number;
    commentsCount: number;
    likesCount: number;
    followersCount: number;
    followingCount: number;
    lastLoginAt?: string;
    preferences: UserPreferences;
  };
  // Propriedades planas para compatibilidade com código existente
  id: string;
  cognitoSub: string;
  email: string;
  emailVerified: boolean;
  nickname: string;
  fullName: string;
  avatar?: string;
  bio?: string;
  website?: string;
  socialLinks?: any;
  role: UserRoleType;
  isActive: boolean;
  isBanned: boolean;
  postsCount: number;
  commentsCount: number;
  likesCount: number;
  followersCount: number;
  followingCount: number;
  lastLoginAt?: string;
  preferences: UserPreferences;
}

/**
 * Perfil do usuário
 */
export interface UserProfile {
  fullName?: string;
  avatar?: string;
  bio?: string;
  preferences?: UserPreferences;
}

/**
 * Preferências do usuário
 */
export interface UserPreferences {
  theme: 'light' | 'dark' | 'system';
  language: string;
  emailNotifications: boolean;
  pushNotifications: boolean;
  newsletter: boolean;
}

/**
 * Opções para listagem de usuários
 */
export interface ListUsersOptions {
  limit?: number;
  exclusiveStartKey?: any;
  filter?: {
    role?: UserRoleType;
    isActive?: boolean;
  };
  sortBy?: 'createdAt' | 'updatedAt' | 'fullName';
  sortOrder?: 'ASC' | 'DESC';
}

/**
 * Resultado da listagem de usuários
 */
export interface UserListResult {
  users: UserEntity[];
  lastEvaluatedKey?: any;
  totalCount: number;
}
