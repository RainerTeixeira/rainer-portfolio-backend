/**
 * Database Module com Factory Pattern
 * 
 * Permite selecionar dinamicamente entre Prisma e DynamoDB
 * baseado na variável de ambiente DATABASE_PROVIDER.
 */

import { Module, DynamicModule, Provider } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service.js';
import { env } from '../config/env.js';
import { UsersRepository } from '../modules/users/users.repository.js';
import { DynamoDBUsersRepository } from './dynamodb/users.repository.js';
import { DynamoDBPostsRepository } from './dynamodb/posts.repository.js';
import { DynamoDBCategoriesRepository } from './dynamodb/categories.repository.js';
import { DynamoDBCommentsRepository } from './dynamodb/comments.repository.js';
import {
  USERS_REPOSITORY_TOKEN,
  POSTS_REPOSITORY_TOKEN,
  CATEGORIES_REPOSITORY_TOKEN,
  COMMENTS_REPOSITORY_TOKEN,
  LIKES_REPOSITORY_TOKEN,
  BOOKMARKS_REPOSITORY_TOKEN,
  NOTIFICATIONS_REPOSITORY_TOKEN,
} from './tokens';

// Importar outros repositórios Prisma
import { PostsRepository } from '../modules/posts/posts.repository.js';
import { CategoriesRepository } from '../modules/categories/categories.repository.js';
import { CommentsRepository } from '../modules/comments/comments.repository.js';
import { LikesRepository } from '../modules/likes/likes.repository.js';
import { BookmarksRepository } from '../modules/bookmarks/bookmarks.repository.js';
import { NotificationsRepository } from '../modules/notifications/notifications.repository.js';

export interface DatabaseModuleOptions {
  provider?: 'PRISMA' | 'DYNAMODB';
}

@Module({})
export class DatabaseModule {
  /**
   * Cria módulo dinâmico baseado no provider
   */
  static register(options: DatabaseModuleOptions = {}): DynamicModule {
    const provider = options.provider || env.DATABASE_PROVIDER;
    
    const providers: Provider[] = [];
    
    // Adicionar PrismaService sempre (pode ser usado por outros módulos)
    providers.push(PrismaService);
    
    // Providers de repositórios baseados no selection
    switch (provider) {
      case 'PRISMA':
        providers.push(
          {
            provide: USERS_REPOSITORY_TOKEN,
            useClass: UsersRepository,
          },
          {
            provide: POSTS_REPOSITORY_TOKEN,
            useClass: PostsRepository,
          },
          {
            provide: CATEGORIES_REPOSITORY_TOKEN,
            useClass: CategoriesRepository,
          },
          {
            provide: COMMENTS_REPOSITORY_TOKEN,
            useClass: CommentsRepository,
          },
          {
            provide: LIKES_REPOSITORY_TOKEN,
            useClass: LikesRepository,
          },
          {
            provide: BOOKMARKS_REPOSITORY_TOKEN,
            useClass: BookmarksRepository,
          },
          {
            provide: NOTIFICATIONS_REPOSITORY_TOKEN,
            useClass: NotificationsRepository,
          },
        );
        break;
        
      case 'DYNAMODB':
        providers.push(
          {
            provide: USERS_REPOSITORY_TOKEN,
            useClass: DynamoDBUsersRepository,
          },
          {
            provide: POSTS_REPOSITORY_TOKEN,
            useClass: DynamoDBPostsRepository,
          },
          {
            provide: CATEGORIES_REPOSITORY_TOKEN,
            useClass: DynamoDBCategoriesRepository,
          },
          {
            provide: COMMENTS_REPOSITORY_TOKEN,
            useClass: DynamoDBCommentsRepository,
          },
          // Fallback para Prisma enquanto outros repositórios não são implementados
          {
            provide: LIKES_REPOSITORY_TOKEN,
            useClass: LikesRepository,
          },
          {
            provide: BOOKMARKS_REPOSITORY_TOKEN,
            useClass: BookmarksRepository,
          },
          {
            provide: NOTIFICATIONS_REPOSITORY_TOKEN,
            useClass: NotificationsRepository,
          },
        );
        break;
        
      default:
        throw new Error(`Invalid database provider: ${provider}`);
    }
    
    return {
      module: DatabaseModule,
      providers,
      exports: [
        PrismaService,
        USERS_REPOSITORY_TOKEN,
        POSTS_REPOSITORY_TOKEN,
        CATEGORIES_REPOSITORY_TOKEN,
        COMMENTS_REPOSITORY_TOKEN,
        LIKES_REPOSITORY_TOKEN,
        BOOKMARKS_REPOSITORY_TOKEN,
        NOTIFICATIONS_REPOSITORY_TOKEN,
      ],
      global: true, // Tornar disponível globalmente
    };
  }
  
  /**
   * Helper para obter o provider atual
   */
  static getCurrentProvider(): 'PRISMA' | 'DYNAMODB' {
    return env.DATABASE_PROVIDER;
  }
}
